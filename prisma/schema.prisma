// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String    @id @default(uuid(7)) @db.Uuid
  email              String    @unique @db.VarChar(100)
  username           String    @unique @db.VarChar(100)
  password           String    @db.VarChar(255)
  is_verified        Boolean   @default(false)
  timezone           String    @default("UTC") @db.VarChar(50)
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt
  deleted_at         DateTime?
  deleted_expires_at DateTime?

  auth_session            auth_session[]
  emailVerifications      EmailVerification[]
  passwordResets          PasswordReset[]
  accounts                Accounts[]
  playbooks               Playbooks[]
  accountRecoveryTokens   AccountRecoveryTokens[]
  EmailChangeVerification EmailChangeVerification[]

  @@index([deleted_at, deleted_expires_at])
  @@map("users")
}

model auth_session {
  id          String    @id @default(uuid(7)) @db.Uuid
  user_id     String    @db.Uuid
  token       String    @db.VarChar(255)
  device_info String    @db.VarChar(255)
  user_agent  String    @db.VarChar(255)
  ip_address  String    @db.VarChar(255)
  browser     String    @db.VarChar(50)
  os          String    @db.VarChar(50)
  revoked_at  DateTime?
  expires_at  DateTime
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("auth_session")
}

model EmailVerification {
  id         String   @id @default(uuid(7)) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique @db.VarChar(255)
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("email_verifications")
}

model PasswordReset {
  id         String   @id @default(uuid(7)) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique @db.VarChar(255)
  expires_at DateTime
  used       Boolean  @default(false)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model AccountRecoveryTokens {
  id         String   @id @default(uuid(7)) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique @db.VarChar(255)
  expires_at DateTime
  used       Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("account_recovery_tokens")
}

model EmailChangeVerification {
  id         String   @id @default(uuid(7)) @db.Uuid
  user_id    String   @db.Uuid
  otp        String   @db.VarChar(6)
  used       Boolean  @default(false)
  expires_at DateTime
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, otp])
  @@map("email_change_verification")
}

model Accounts {
  id             String   @id @default(uuid(7)) @db.Uuid
  user_id        String   @db.Uuid
  nickname       String   @db.VarChar(255)
  exchange       String   @db.VarChar(50)
  balance        Decimal  @default(0)
  risk_per_trade Decimal  @default(1.00)
  max_risk_daily Decimal  @default(3.00)
  is_archived    Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  user           User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  trades         Trades[]

  @@index([user_id, is_archived])
  @@map("accounts")
}

model Playbooks {
  id             String           @id @default(uuid(7)) @db.Uuid
  user_id        String           @db.Uuid
  name           String           @db.VarChar(255)
  description    String           @db.VarChar(255)
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  deleted_at     DateTime?
  user           User             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  tradePlaybooks TradePlaybooks[]

  @@index([user_id, deleted_at])
  @@map("playbooks")
}

enum TradeStatus {
  Running
  Closed
}

enum TradeResult {
  Win
  BE
  Lose
}

enum PositionType {
  Long
  Short
}

model Trades {
  id             String           @id @default(uuid(7)) @db.Uuid
  account_id     String           @db.Uuid
  pair           String           @db.VarChar(50)
  position       PositionType
  entry_price    Decimal          @default(0)
  position_size  Decimal          @default(0)
  sl_price       Decimal          @default(0)
  tp_price       Decimal          @default(0)
  entry_time     DateTime         @default(now())
  exit_time      DateTime?
  trade_duration Int              @default(0)
  trade_result   TradeResult
  pnl            Decimal          @default(0)
  risk_reward    Decimal          @default(0)
  rr_actual      Decimal          @default(0)
  status         TradeStatus      @default(Running)
  notes          String?          @db.Text
  link_img       String?          @db.Text
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  account        Accounts         @relation(fields: [account_id], references: [id], onDelete: Cascade)
  tradePlaybooks TradePlaybooks[]

  @@index([account_id, status])
  @@map("trades")
}

model TradePlaybooks {
  id          String    @id @default(uuid(7)) @db.Uuid
  trade_id    String    @db.Uuid
  playbook_id String    @db.Uuid
  trade       Trades    @relation(fields: [trade_id], references: [id], onDelete: Cascade)
  playbook    Playbooks @relation(fields: [playbook_id], references: [id], onDelete: Cascade)

  @@unique([trade_id, playbook_id])
  @@map("trade_playbooks")
}
