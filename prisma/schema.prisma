// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String    @id @default(uuid(7)) @db.Uuid
  email              String    @unique @db.VarChar(100)
  username           String    @unique @db.VarChar(100)
  password           String    @db.VarChar(255)
  is_verified        Boolean   @default(false)
  timezone           String    @default("UTC") @db.VarChar(50)
  created_at         DateTime  @db.Timestamptz() @default(now())
  updated_at         DateTime  @db.Timestamptz() @updatedAt
  deleted_at         DateTime? @db.Timestamptz()
  deleted_expires_at DateTime? @db.Timestamptz()

  auth_session            auth_session[]
  emailVerifications      EmailVerification[]
  passwordResets          PasswordReset[]
  accounts                Accounts[]
  playbooks               Playbooks[]
  accountRecoveryTokens   AccountRecoveryTokens[]
  EmailChangeVerification EmailChangeVerification[]

  @@index([deleted_at, deleted_expires_at])
  @@map("users")
}

model auth_session {
  id          String    @id @default(uuid(7)) @db.Uuid
  user_id     String    @db.Uuid
  token       String    @db.VarChar(255)
  device_info String    @db.VarChar(255)
  user_agent  String    @db.VarChar(255)
  ip_address  String    @db.VarChar(255)
  browser     String    @db.VarChar(50)
  os          String    @db.VarChar(50)
  revoked_at  DateTime? @db.Timestamptz()
  expires_at  DateTime  @db.Timestamptz()
  created_at  DateTime  @db.Timestamptz() @default(now())
  updated_at  DateTime  @db.Timestamptz() @updatedAt
  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("auth_session")
}

model EmailVerification {
  id         String   @id @default(uuid(7)) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique @db.VarChar(255)
  expires_at DateTime @db.Timestamptz()
  used       Boolean  @default(false)
  created_at DateTime @db.Timestamptz() @default(now())
  updated_at DateTime @db.Timestamptz() @updatedAt
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("email_verifications")
}

model PasswordReset {
  id         String   @id @default(uuid(7)) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique @db.VarChar(255)
  expires_at DateTime @db.Timestamptz()
  used       Boolean  @default(false)
  created_at DateTime @db.Timestamptz() @default(now())
  updated_at DateTime @db.Timestamptz() @updatedAt
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model AccountRecoveryTokens {
  id         String   @id @default(uuid(7)) @db.Uuid
  user_id    String   @db.Uuid
  token      String   @unique @db.VarChar(255)
  expires_at DateTime @db.Timestamptz()
  used       Boolean  @default(false)
  created_at DateTime @db.Timestamptz() @default(now())
  updated_at DateTime @db.Timestamptz() @updatedAt
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("account_recovery_tokens")
}

model EmailChangeVerification {
  id         String   @id @default(uuid(7)) @db.Uuid
  user_id    String   @db.Uuid
  new_email  String   @db.VarChar(100)
  otp        String   @db.VarChar(6)
  used       Boolean  @default(false)
  expires_at DateTime @db.Timestamptz()
  created_at DateTime @db.Timestamptz() @default(now())
  updated_at DateTime @db.Timestamptz() @updatedAt
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, otp])
  @@map("email_change_verification")
}

model Accounts {
  id             String   @id @default(uuid(7)) @db.Uuid
  user_id        String   @db.Uuid
  nickname       String   @db.VarChar(255)
  exchange       String   @db.VarChar(50)
  balance        Decimal  @db.Decimal(18,8)
  risk_per_trade Decimal  @db.Decimal(5,4)
  max_risk_daily Decimal  @db.Decimal(5,4)
  is_archived    Boolean  @default(false)
  created_at     DateTime @db.Timestamptz() @default(now())
  updated_at     DateTime @db.Timestamptz() @updatedAt
  user           User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  trades         Trades[]

  @@index([user_id, is_archived])
  @@map("accounts")
}

model Playbooks {
  id              String           @id @default(uuid(7)) @db.Uuid
  user_id         String           @db.Uuid
  name            String           @db.VarChar(255)
  description     String?          @db.Text
  created_at      DateTime         @db.Timestamptz() @default(now())
  updated_at      DateTime         @db.Timestamptz() @updatedAt
  user            User             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  trade_playbooks TradePlaybooks[]

  @@index([user_id])
  @@map("playbooks")
}

enum TradeStatus {
  Running
  Closed
}

enum TradeResult {
  Win
  BE
  Lose
}

enum PositionType {
  Long
  Short
}

model Trades {
  id              String           @id @default(uuid(7)) @db.Uuid
  account_id      String           @db.Uuid
  pair            String           @db.VarChar(50)
  position        PositionType
  entry_price     Decimal          @db.Decimal(18,8)
  position_size   Decimal          @db.Decimal(18,8)
  exit_price      Decimal?         @db.Decimal(18,8) 
  sl_price        Decimal?         @db.Decimal(18,8)
  tp_price        Decimal?         @db.Decimal(18,8)
  entry_time      DateTime         @db.Timestamptz()
  exit_time       DateTime?        @db.Timestamptz()
  risk_amount     Decimal?         @db.Decimal(18,8) 
  trade_duration  Int?
  trade_result    TradeResult?
  pnl             Decimal?         @db.Decimal(18,8)
  risk_reward     Decimal?         @db.Decimal(5,2)
  rr_actual       Decimal?         @db.Decimal(5,2)
  status          TradeStatus      @default(Running)
  notes           String?          @db.Text
  link_img        String?          @db.Text
  created_at      DateTime         @db.Timestamptz() @default(now())
  updated_at      DateTime         @db.Timestamptz() @updatedAt
  account         Accounts         @relation(fields: [account_id], references: [id], onDelete: Cascade)
  trade_playbooks TradePlaybooks[]

  @@index([account_id, status])
  @@map("trades")
}

model TradePlaybooks {
  id          String    @id @default(uuid(7)) @db.Uuid
  trade_id    String    @db.Uuid
  playbook_id String    @db.Uuid
  trade       Trades    @relation(fields: [trade_id], references: [id], onDelete: Cascade)
  playbook    Playbooks @relation(fields: [playbook_id], references: [id], onDelete: Cascade)

  @@unique([trade_id, playbook_id])
  @@map("trade_playbooks")
}
